<!-- ANIMATEK 90’ – Divi (v3.7: KPI semanal con reset Domingo + Top-4) -->
<section id="animatek90" style="--bg:#ffffff;--card:#f7f9fc;--muted:#5b6474;--fg:#0b1020;--line:#e6ebf5;--accent:#cc00ff;--accent2:#24b979;">
    <style>
    :root{color-scheme:light}
    #animatek90 *{box-sizing:border-box}
    #animatek90{color:var(--fg);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif;background:var(--bg);margin:clamp(28px,4vw,56px) 0;}
    #animatek90 .wrap{max-width:1100px;margin:0 auto;padding:24px 18px}
    #animatek90 .card,#animatek90 .kpi{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    
    /* KPIs superiores */
    #animatek90 .kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px}
    #animatek90 .kpi{padding:20px;}
    #animatek90 .kpi-label{font-size:12px;color:var(--muted);letter-spacing:.2px;margin-bottom:6px}
    #animatek90 .kpi-value{font-size:34px;font-weight:700}
    #animatek90 .kpi-foot{font-size:12px;color:var(--muted)}
    /* Progreso semanal */
    #animatek90 .kpi-progress{margin-top:8px;height:10px;border-radius:999px;border:1px solid var(--line);background:#eef2fa;overflow:hidden}
    #animatek90 .kpi-progress>div{height:100%;width:0%;background:var(--accent2);transition:width .3s ease}
    #animatek90 .kpi.progress-done .kpi-progress>div{background:linear-gradient(90deg,var(--accent2),#30cea0)}
    
    /* Donut + Leyenda */
    #animatek90 .donut-card{padding:16px;margin-bottom:12px;display:grid;grid-template-columns:280px 1fr;grid-template-rows:auto 1fr;grid-template-areas:"topbar topbar" "donut legend";gap:16px;align-items:center}
    #animatek90 .topbar{grid-area:topbar;display:flex;align-items:center;justify-content:space-between}
    #animatek90 .scope{display:inline-flex;background:#f3f5fb;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    #animatek90 .scope button{padding:6px 10px;font-size:12px;border:0;background:transparent;cursor:pointer}
    #animatek90 .scope button.active{background:#fff}
    #animatek90 .donut-wrap{grid-area:donut;display:flex;align-items:center;justify-content:center}
    #animatek90 .donut{--size:180px;width:var(--size);height:var(--size);border-radius:50%;background:conic-gradient(#e6ebf5 0 360deg);position:relative}
    #animatek90 .donut::after{content:"";position:absolute;inset:12px;background:var(--card);border-radius:50%;box-shadow:inset 0 0 0 1px var(--line)}
    #animatek90 .donut-center{position:absolute;inset:0;display:grid;place-items:center;text-align:center;padding:12px}
    #animatek90 .center-top{font-size:12px;color:var(--muted)}
    #animatek90 .center-value{font-size:28px;font-weight:800}
    #animatek90 .center-foot{font-size:12px;color:var(--muted)}
    #animatek90 .legend{grid-area:legend;list-style:none;margin:0;padding:0;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;align-content:start}
    #animatek90 .legend li{display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer}
    #animatek90 .legend li.active{background:#fff;border:1px solid var(--line);border-radius:8px;padding:4px 6px}
    #animatek90 .swatch{width:12px;height:12px;border-radius:3px;border:1px solid var(--line)}
    
    /* KPIs categorías */
    #animatek90 .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
    #animatek90 .cat{padding:14px;border:1px solid var(--line);border-radius:12px;background:var(--card);cursor:pointer}
    #animatek90 .cat.active{outline:2px solid var(--accent2)}
    #animatek90 .cat .name{font-size:13px;color:var(--muted);margin-bottom:4px}
    #animatek90 .cat .hours{font-size:22px;font-weight:700;margin-bottom:8px}
    #animatek90 .bar{height:8px;background:linear-gradient(90deg,var(--c) var(--w),#e9edf6 var(--w));border-radius:6px;border:1px solid var(--line)}
    
    /* Tabla sesiones */
    #animatek90 .sessions{padding:16px;margin-top:12px}
    #animatek90 .sessions-head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin:0 0 10px}
    #animatek90 .sessions h3{margin:0;font-size:14px;color:#3a4354}
    #animatek90 .pill{background:#f3f5fb;border:1px solid var(--line);border-radius:999px;padding:6px 12px;font-size:12px;cursor:pointer}
    #animatek90 table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    #animatek90 th,#animatek90 td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:14px;text-align:left}
    #animatek90 th{background:#f2f5fb;color:#2b3345}
    #animatek90 td a{color:#1b61db;text-decoration:none}
    
    /* Responsive */
    @media (max-width:980px){#animatek90 .donut-card{grid-template-columns:240px 1fr}}
    @media (max-width:860px){
      #animatek90 .grid-4{grid-template-columns:repeat(2,1fr)}
      #animatek90 .donut-card{grid-template-columns:1fr;grid-template-rows:auto auto auto;grid-template-areas:"topbar" "donut" "legend"}
      #animatek90 .legend{grid-template-columns:1fr}
    }
    @media (max-width:480px){
      #animatek90 .kpi-grid{grid-template-columns:1fr}
      #animatek90 .donut{--size:160px}
    }
    </style>
    
    <div class="wrap">
      <section class="kpi-grid">
        <!-- KPI único de semana -->
        <article class="kpi kpi-week" id="kpi-week">
          <div class="kpi-label">Horas esta semana</div>
          <div class="kpi-value"><span id="kpi-week-hours">—</span></div>
          <div class="kpi-foot" id="kpi-week-foot">Objetivo: 15 h</div>
          <div class="kpi-progress"><div id="kpi-week-bar"></div></div>
        </article>
        <!-- Total acumulado histórico -->
        <article class="kpi">
          <div class="kpi-label">Horas acumuladas</div>
          <div class="kpi-value" id="kpi-total-hours">—</div>
          <div class="kpi-foot">todas las categorías</div>
        </article>
      </section>
    
      <section class="card donut-card">
        <div class="topbar">
          <div id="scopeLabel" style="font-size:12px;color:var(--muted)">Top-4 por: Mes actual</div>
          <div class="scope" aria-label="Cambiar contexto de Top-4">
            <button type="button" data-scope="month" class="active">Mes</button>
            <button type="button" data-scope="hist">Histórico</button>
          </div>
        </div>
        <div class="donut-wrap">
          <div class="donut" id="donut" role="img" aria-label="Distribución de horas por categoría">
            <div class="donut-center">
              <div class="center-top">Total</div>
              <div class="center-value" id="donut-total">—</div>
              <div class="center-foot">horas</div>
            </div>
          </div>
        </div>
        <ul class="legend" id="legend"></ul>
      </section>
    
      <section class="grid-4" id="categories"></section>
    
      <section class="card sessions" id="sessions">
        <div class="sessions-head">
          <h3>Sesiones</h3>
          <div style="display:flex;gap:10px;align-items:center">
            <div id="sessions-label" style="font-size:12px;color:var(--muted)"></div>
            <button id="toggleHist" class="pill">Mostrar histórico</button>
          </div>
        </div>
        <table>
          <thead><tr><th>Duración (min)</th><th>Categoría</th><th>Sesión</th><th>Fecha</th><th>URL</th></tr></thead>
          <tbody id="akTbody"></tbody>
        </table>
      </section>
    </div>
    
    <script>
    (()=>{ // IIFE
      const RAW_CSV = "URl";
      const CSV_URL = "https://r.jina.ai/http://" + RAW_CSV.replace(/^https?:\/\//,'');
      const WEEK_GOAL_HOURS = 15;
    
      const NOW = new Date(); // hora local (Europa/Madrid)
      const NOW_Y = NOW.getFullYear(), NOW_M = NOW.getMonth();
    
      /* ---------- Utils ---------- */
      function parseCSV(text){
        let s=(text||'').replace(/^\uFEFF/,'').replace(/\r\n?/g,'\n');
        const first=s.split('\n',1)[0]||'';
        const delim=(first.match(/;/g)||[]).length>(first.match(/,/g)||[]).length?';':',';
        const rows=[]; let cur=[],field='',q=false;
        for(let i=0;i<s.length;i++){
          const c=s[i], n=s[i+1];
          if(q){ if(c=='"'&&n=='"'){field+='"';i++;} else if(c=='"'){q=false;} else field+=c; }
          else { if(c=='"'){q=true;} else if(c===delim){cur.push(field);field='';}
                 else if(c=='\n'){cur.push(field);rows.push(cur);cur=[];field='';} else field+=c; }
        }
        if(field!==''||cur.length){cur.push(field);rows.push(cur);}
        return rows.map(r=>r.map(x=>String(x??'').trim()));
      }
      const toNum = x => { const n=parseFloat(String(x).replace(',','.')); return isNaN(n)?0:n; };
      const fmt   = n => (Math.round(n*10)/10).toString().replace('.',',');
      const tcase = s => (s||'').replace(/\w\S*/g,t=>t[0].toUpperCase()+t.slice(1));
    
      
      // 1) Parser de fechas tolerante (acepta dd/mm/yyyy [hh:mm], dd-mm-yyyy, yyyy-mm-dd, yyyy/mm/dd, y dd/mm/yy)
    function parseDateFlexible(raw){
      if(!raw) return null;
      // quita hora si viene: "19/09/2025 08:20" -> "19/09/2025"
      let s = String(raw).trim().split(/[ T]/)[0];
    
      // dd/mm/yyyy o dd-mm-yyyy o dd.mm.yyyy
      let m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
      if(m){
        let dd = +m[1], mm = +m[2]-1, yy = +m[3];
        if(yy < 100) yy += 2000; // soporta dd/mm/yy
        const d = new Date(yy, mm, dd);
        return isNaN(d) ? null : d;
      }
      // yyyy-mm-dd o yyyy/mm/dd
      m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
      if(m){
        const d = new Date(+m[1], +m[2]-1, +m[3]);
        return isNaN(d) ? null : d;
      }
      // último intento con Date nativo
      const d = new Date(s);
      return isNaN(d) ? null : d;
    }


    function parseDurationToMinutes(raw){
          if(raw==null) return 0;
          if(typeof raw === "number" && isFinite(raw)){
            if(raw>0 && raw<1) return raw*1440; // Google Sheets a veces exporta duración como fracción de día
            return raw;
          }
          const txt = String(raw).trim();
          if(!txt) return 0;
          const normalized = txt.replace(',', '.');
          if(/^-?\d+(\.\d+)?$/.test(normalized)){
            const num = parseFloat(normalized);
            if(!isNaN(num)){
              if(num>0 && num<1) return num*1440;
              return num;
            }
          }
          const colon = normalized.match(/^(\d+):(\d{1,2})(?::(\d{1,2}))?$/);
          if(colon){
            const first = parseInt(colon[1],10);
            const second = parseInt(colon[2],10);
            const third = colon[3] ? parseInt(colon[3],10) : 0;
            if(first >= 24 && !colon[3]){
              return first + second/60;
            }
            return first*60 + second + third/60;
          }
          const iso = normalized.match(/^PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?$/i);
          if(iso){
            const h = parseInt(iso[1]||0,10);
            const m = parseInt(iso[2]||0,10);
            const s = parseInt(iso[3]||0,10);
            return h*60 + m + s/60;
          }
          const human = normalized.match(/(\d+(?:\.\d+)?)\s*h(?:oras?)?(?:\s+(\d+(?:\.\d+)?)\s*m(?:inutos?)?)?/i);
          if(human){
            const h = parseFloat(human[1]||0);
            const m = parseFloat(human[2]||0);
            return h*60 + m;
          }
          return 0;
        }









    
    // 2) Mapeo de columnas robusto (tolera espacios y tildes)
    function mapRows(arr){
      if(!arr.length) return [];
      const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
      const header = arr[0].map(norm);
      const find = (...keys)=> header.findIndex(h => keys.some(k => h.includes(k)));
    
      let iCat = find('categoria','category');
      let iDur = find('duracion','minutos','duration');
      let iDat = find('fecha','date');
      let iSes = find('sesion','session');
      let iUrl = find('url','enlace','link');
    
      // Fallbacks por posición (A,B,C,D,E,F) según tu hoja: A=Categoria, B=Duración, D=Fecha, E=Sesión, F=URL
      if(iCat<0) iCat=0;
      if(iDur<0) iDur=1;
      if(iDat<0) iDat=3;
      if(iSes<0) iSes=4;
      if(iUrl<0) iUrl=5;
    
      const out=[];
      for(let r=1;r<arr.length;r++){
        const row = arr[r];
        if(!row || row.every(x=>!x)) continue;
    
        const categoria = row[iCat]||'';
         const durMin    = parseDurationToMinutes(row[iDur]);
        const fechaRaw  = row[iDat]||'';
        const d         = parseDateFlexible(fechaRaw);
        if(!d) continue;
    
        out.push({
          categoria,
          duracion: durMin,
          fechaISO: d.toISOString().slice(0,10),
          fechaRaw,
          sesion: (row[iSes]||''),
          youtube: (row[iUrl]||''),
          y: d.getFullYear(),
          m: d.getMonth()
        });
      }
      return out;
    }
    
      
      
      
      
      
      
      
      
      
      function conicStops(parts){
        const total = parts.reduce((a,b)=>a+b.hours,0); if(total<=0) return "#e6ebf5 0 360deg";
        let acc=0; return parts.map(p=>{ const from=(acc/total)*360; acc+=p.hours; const to=(acc/total)*360; return `${p.color} ${from}deg ${to}deg`; }).join(', ');
      }



   


      async function getCSV(){
       const res = await fetch(CSV_URL,{cache:'no-store'});
       if(!res.ok) throw new Error("HTTP "+res.status);
       return res.text();
     }



      /* ---------- Semana actual (L→D) ---------- */
      function weekRangeISO(d=new Date()){
        // dow: 0=Domingo ... 6=Sábado → queremos lunes como inicio
        const dow = (d.getDay()+6)%7; // 0=Lunes ... 6=Domingo
        const monday = new Date(d.getFullYear(), d.getMonth(), d.getDate()-dow); // 00:00 local
        const sunday = new Date(monday.getFullYear(), monday.getMonth(), monday.getDate()+6); // 00:00 Domingo
        // Consideramos hasta el final del domingo (23:59:59.999), pero para comparar YYYY-MM-DD nos basta el día
        const toISO = x => x.toISOString().slice(0,10);
        return { fromISO: toISO(monday), toISO: toISO(sunday) };
      }
    
      /* ---------- Estado ---------- */
      let rows=[];                 // todas las filas válidas
      let topScope='month';        // 'month' | 'hist'
      let showAll=false;           // tabla sesiones
      let catFilter=null;          // filtro de categoría
    
      /* ---------- Top-4 ---------- */
      const donutEl   = document.getElementById('donut');
      const legendEl  = document.getElementById('legend');
      const catsEl    = document.getElementById('categories');
      const scopeEl   = document.querySelector('.scope');
      const scopeLbl  = document.getElementById('scopeLabel');
    
      function baseHue(name){
        const k = (name||'').toLowerCase().trim();
        if(k.startsWith('bitwig'))   return 295;
        if(k.startsWith('digitakt')) return 220;
        if(k.startsWith('vcv rack')) return 150;
        if(k.startsWith('oxi one'))  return 165;
        let h=0; for(let i=0;i<k.length;i++) h=(h*31+k.charCodeAt(i))%360;
        return h;
      }
      function angDist(a,b){ let d=Math.abs(a-b)%360; return d>180?360-d:d; }
      function paletteFor(names){
        const items = names.map(n=>({name:n, h:baseHue(n)})).sort((a,b)=>a.h-b.h);
        const used = []; const res  = {}; const MIN=28; const GOLD=137.50776405;
        for(const it of items){
          let h=it.h, tries=0;
          while(tries<18 && used.some(u=>angDist(u,h)<MIN)){ h=(h+GOLD)%360; tries++; }
          used.push(h); res[it.name]=`hsl(${Math.round(h)} 65% 46%)`;
        }
        return res;
      }
      function calcParts(){
        const base = (topScope==='month') ? rows.filter(r=>r.y===NOW.getFullYear() && r.m===NOW.getMonth()) : rows;
        const ordered = base.slice().sort((a,b)=>b.fechaISO.localeCompare(a.fechaISO));
        const last4=[], seen=new Set();
        for(const r of ordered){
          const name=(r.categoria||'').trim(); const key=name.toLowerCase();
          if(!key || seen.has(key)) continue;
          seen.add(key); last4.push(name); if(last4.length===4) break;
        }
        if(!last4.length) last4.push('Sin categoría');
        const hoursBy = Object.fromEntries(last4.map(n=>[n,0]));
        base.forEach(r=>{
          const k=(r.categoria||'').trim().toLowerCase();
          const hit=last4.find(n=>n.toLowerCase()===k);
          if(hit) hoursBy[hit]+=r.duracion/60;
        });
        const palette = paletteFor(last4);
        return last4.map(name=>({ name, hours: hoursBy[name]||0, color: palette[name] }));
      }
      function renderTop(){
        const parts = calcParts();
        donutEl.style.background = `conic-gradient(${conicStops(parts)})`;
        scopeLbl.textContent = `Top-4 por: ${topScope==='month'?'Mes actual':'Histórico'}`;
        legendEl.innerHTML = parts.map(p => `<li data-cat="${encodeURIComponent(p.name)}"><span class="swatch" style="background:${p.color}"></span><b>${tcase(p.name)}</b> — ${fmt(p.hours)} h</li>`).join('');
        const maxH=Math.max(...parts.map(p=>p.hours),0);
        catsEl.innerHTML = parts.map(p=>{
          const pct = maxH>0 ? Math.max(4,(p.hours/maxH)*100) : 0;
          return `<article class="cat" data-cat="${encodeURIComponent(p.name)}">
            <div class="name">${tcase(p.name)}</div>
            <div class="hours">${fmt(p.hours)} h</div>
            <div class="bar" style="--c:${p.color};--w:${pct}%"></div>
          </article>`;
        }).join('');
        const match = (s)=> decodeURIComponent(s).toLowerCase().trim()=== (catFilter||'');
        [...legendEl.querySelectorAll('li')].forEach(li=>li.classList.toggle('active', match(li.dataset.cat)));
        [...catsEl.querySelectorAll('.cat')].forEach(a=>a.classList.toggle('active', match(a.dataset.cat)));
      }
    
      /* ---------- Sesiones ---------- */
      const tb   = document.getElementById('akTbody');
      const lab  = document.getElementById('sessions-label');
      const btn  = document.getElementById('toggleHist');
      const M    = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    
      function renderSessions(){
        const base = (showAll?rows:rows.filter(r=>r.y===NOW_Y && r.m===NOW_M));
        const filtered = catFilter ? base.filter(r => (r.categoria||'').toLowerCase().trim()===catFilter) : base;
        const list = filtered.slice().sort((a,b)=>b.fechaISO.localeCompare(a.fechaISO));
        let html='';
        for(const r of list){
          const url=r.youtube?`<a href="${r.youtube}" target="_blank" rel="noopener">Abrir</a>`:'—';
          const ses=r.sesion||'—';
          html += `<tr><td>${Math.round(r.duracion||0)}</td><td>${r.categoria}</td><td>${ses}</td><td>${r.fechaRaw||r.fechaISO}</td><td>${url}</td></tr>`;
        }
        tb.innerHTML = html || `<tr><td colspan="5" style="color:#6b7280">Sin sesiones en ${M[NOW_M]} ${NOW_Y}</td></tr>`;
        lab.textContent = (showAll ? "Mostrando: histórico completo" : `Mes actual: ${M[NOW_M]} ${NOW_Y}`) + (catFilter? ` · Filtro: ${tcase(catFilter)}` : "");
        btn.textContent = showAll ? "Mostrar solo mes actual" : "Mostrar histórico";
      }
    
      /* ---------- KPI Semana ---------- */
      const weekBox   = document.getElementById('kpi-week');
      const weekValEl = document.getElementById('kpi-week-hours');
      const weekFoot  = document.getElementById('kpi-week-foot');
      const weekBar   = document.getElementById('kpi-week-bar');
    
      function renderWeekKPI(){
        const {fromISO, toISO} = weekRangeISO(NOW);
        // Filtramos por rango YYYY-MM-DD (lexicográfico funciona)
        const minutes = rows
          .filter(r => r.fechaISO >= fromISO && r.fechaISO <= toISO)
          .reduce((a,b)=>a + (b.duracion||0), 0);
        const hours = minutes/60;
        const pct = WEEK_GOAL_HOURS>0 ? Math.min(1, hours / WEEK_GOAL_HOURS) : 0;
    
        weekValEl.textContent = `${fmt(hours)} h`;
        weekFoot.textContent  = `Objetivo: ${fmt(WEEK_GOAL_HOURS)} h · ${fmt(pct*100)}%`;
        weekBar.style.width   = `${pct*100}%`;
    
        // Si cumples o superas, resalta
        weekBox.classList.toggle('progress-done', hours >= WEEK_GOAL_HOURS);
      }
    
      /* ---------- Interacciones ---------- */
     
      scopeEl.addEventListener('click', (e)=>{
        const b=e.target.closest('button[data-scope]'); if(!b) return;
        topScope = b.dataset.scope;
        scopeEl.querySelectorAll('button').forEach(x=>x.classList.toggle('active', x===b));
        renderTop();
      });
      legendEl.addEventListener('click',(e)=>{
        const li=e.target.closest('li[data-cat]'); if(!li) return;
        const sel=decodeURIComponent(li.dataset.cat).toLowerCase().trim();
        catFilter = (catFilter===sel)? null : sel;
        renderTop(); renderSessions();
      });
      catsEl.addEventListener('click',(e)=>{
        const card=e.target.closest('article[data-cat]'); if(!card) return;
        const sel=decodeURIComponent(card.dataset.cat).toLowerCase().trim();
        catFilter = (catFilter===sel)? null : sel;
        renderTop(); renderSessions();
      });
      btn.addEventListener('click',()=>{ showAll=!showAll; renderSessions(); },{passive:true});
    
      /* ---------- Boot ---------- */
      async function main(){
        const csv = await getCSV();
        rows = mapRows(parseCSV(csv));

        if (!rows.length) {
  console.warn('[90m] No se han parseado filas del CSV');
  document.getElementById('sessions-label').textContent = 'No hay datos en la hoja o las fechas no se pudieron leer';
}

    
        // KPIs globales
        const totalMin = rows.reduce((a,b)=>a+b.duracion,0);
        const totalH   = totalMin/60;
        document.getElementById('kpi-total-hours').textContent = fmt(totalH);
        document.getElementById('donut-total').textContent     = fmt(totalH);
    
        // Semana actual
        renderWeekKPI();
    
        // Resto
        renderTop();
        renderSessions();
      }
    
      document.readyState==="loading"
        ? document.addEventListener("DOMContentLoaded", ()=>main().catch(e=>console.error('[90m]',e)))
        : main().catch(e=>console.error('[90m]',e));
    })();
    </script>
    </section>
    