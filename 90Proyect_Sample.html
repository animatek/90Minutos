<!-- ANIMATEK 90’ – v4.0: Fusión Dashboard + Meses/Años/Total -->
<section id="an90-all" style="--bg:#ffffff;--card:#f7f9fc;--muted:#5b6474;--fg:#0b1020;--line:#e6ebf5;--accent:#cc00ff;--accent2:#24b979;">
    <style>
    :root{color-scheme:light}
    #an90-all *{box-sizing:border-box}
    #an90-all{color:var(--fg);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif;background:var(--bg);margin:clamp(28px,4vw,56px) 0}
    #an90-all .wrap{max-width:1100px;margin:0 auto;padding:24px 18px}
    #an90-all .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    #an90-all .muted{color:var(--muted)}
    /* Tabs globales */
    #an90-all .tabs-global{display:flex;gap:8px;margin-bottom:14px}
    #an90-all .tabg{background:#f3f5fb;border:1px solid var(--line);border-radius:999px;padding:8px 14px;font-size:13px;cursor:pointer}
    #an90-all .tabg.active{background:#fff}
    /* --- DASHBOARD (antes #animatek90) --- */
    #an90-all .kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px}
    #an90-all .kpi{padding:20px;background:var(--card);border:1px solid var(--line);border-radius:16px}
    #an90-all .kpi-label{font-size:12px;color:var(--muted);letter-spacing:.2px;margin-bottom:6px}
    #an90-all .kpi-value{font-size:34px;font-weight:700}
    #an90-all .kpi-foot{font-size:12px;color:var(--muted)}
    #an90-all .kpi-progress{margin-top:8px;height:10px;border-radius:999px;border:1px solid var(--line);background:#eef2fa;overflow:hidden}
    #an90-all .kpi-progress>div{height:100%;width:0%;background:var(--accent2);transition:width .3s ease}
    #an90-all .kpi.progress-done .kpi-progress>div{background:linear-gradient(90deg,var(--accent2),#30cea0)}
    #an90-all .donut-card{padding:16px;margin-bottom:12px;display:grid;grid-template-columns:280px 1fr;grid-template-rows:auto 1fr;grid-template-areas:"topbar topbar" "donut legend";gap:16px;align-items:center}
    #an90-all .topbar{grid-area:topbar;display:flex;align-items:center;justify-content:space-between}
    #an90-all .scope{display:inline-flex;background:#f3f5fb;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    #an90-all .scope button{padding:6px 10px;font-size:12px;border:0;background:transparent;cursor:pointer}
    #an90-all .scope button.active{background:#fff}
    #an90-all .donut-wrap{grid-area:donut;display:flex;align-items:center;justify-content:center}
    #an90-all .donut{--size:180px;width:var(--size);height:var(--size);border-radius:50%;background:conic-gradient(#e6ebf5 0 360deg);position:relative}
    #an90-all .donut::after{content:"";position:absolute;inset:12px;background:var(--card);border-radius:50%;box-shadow:inset 0 0 0 1px var(--line)}
    #an90-all .donut-center{position:absolute;inset:0;display:grid;place-items:center;text-align:center;padding:12px}
    #an90-all .center-top{font-size:12px;color:var(--muted)}
    #an90-all .center-value{font-size:28px;font-weight:800}
    #an90-all .center-foot{font-size:12px;color:var(--muted)}
    #an90-all .legend{grid-area:legend;list-style:none;margin:0;padding:0;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;align-content:start}
    #an90-all .legend li{display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer}
    #an90-all .legend li.active{background:#fff;border:1px solid var(--line);border-radius:8px;padding:4px 6px}
    #an90-all .swatch{width:12px;height:12px;border-radius:3px;border:1px solid var(--line)}
    #an90-all .grid-4{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:12px}
    #an90-all .cat{padding:14px;border:1px solid var(--line);border-radius:12px;background:var(--card);cursor:pointer}
    #an90-all .cat.active{outline:2px solid var(--accent2)}
    #an90-all .cat .name{font-size:13px;color:var(--muted);margin-bottom:4px}
    #an90-all .cat .hours{font-size:22px;font-weight:700;margin-bottom:8px}
    #an90-all .bar{height:8px;background:linear-gradient(90deg,var(--c) var(--w),#e9edf6 var(--w));border-radius:6px;border:1px solid var(--line)}
    #an90-all .sessions{padding:16px;margin-top:12px}
    #an90-all .demo-banner{display:none;align-items:center;gap:8px;margin:0 0 12px;padding:10px 14px;border-radius:12px;border:1px dashed var(--accent2);background:rgba(36,185,121,.08);font-size:13px;color:#056847}
    #an90-all .sessions-head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin:0 0 10px}
    #an90-all .sessions h3{margin:0;font-size:14px;color:#3a4354}
    #an90-all .pill{background:#f3f5fb;border:1px solid var(--line);border-radius:999px;padding:6px 12px;font-size:12px;cursor:pointer}
    #an90-all table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    #an90-all th,#an90-all td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:14px;text-align:left}
    #an90-all th{background:#f2f5fb;color:#2b3345}
    #an90-all td a{color:#1b61db;text-decoration:none}
    /* --- MESES/AÑOS/TOTAL (antes #an-90m) --- */
    #an90-all .agg .card{border-radius:16px}
    #an90-all .head{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    #an90-all .tabs{display:flex;gap:6px}
    #an90-all .tab{background:#f3f4f6;border:1px solid var(--line);border-radius:999px;padding:6px 12px;font-size:13px;cursor:pointer}
    #an90-all .tab.active{background:#eef2ff;border-color:#c7d2fe;color:#1f2a7a}
    #an90-all select{background:#fff;border:1px solid var(--line);border-radius:10px;padding:6px 10px}
    #an90-all .kpi-total{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:6px}
    #an90-all .kpi-total .box{background:#f9fafb;border:1px solid var(--line);border-radius:10px;padding:12px}
    #an90-all .kpi-total .title{font-size:12px;color:var(--muted);margin-bottom:4px}
    #an90-all .kpi-total .value{font-size:26px;font-weight:800}
    /* Responsive */
    @media (max-width:980px){#an90-all .donut-card{grid-template-columns:240px 1fr}}
    @media (max-width:860px){
      #an90-all .grid-4{grid-template-columns:repeat(2,1fr)}
      #an90-all .donut-card{grid-template-columns:1fr;grid-template-rows:auto auto auto;grid-template-areas:"topbar" "donut" "legend"}
      #an90-all .legend{grid-template-columns:1fr}
    }
    @media (max-width:480px){#an90-all .kpi-grid{grid-template-columns:1fr} #an90-all .donut{--size:160px}}
    </style>
  
    <div class="wrap">
      <!-- Tabs globales -->
      <div class="tabs-global">
        <button class="tabg active" data-pane="dashboard">Dashboard</button>
        <button class="tabg" data-pane="agg">Meses / Años / Total</button>
      </div>
      <div class="demo-banner" id="demoBanner">
        <strong>Demo</strong>
        <span>Usa datos de muestra. Pasa `?csv=URL_PUBLICA` o define `window.ANIMATEK90_CSV_URL` para usar tu hoja.</span>
      </div>

      <!-- PANE: DASHBOARD -->
      <div id="pane-dashboard">
        <section class="kpi-grid">
          <article class="kpi kpi-week" id="kpi-week">
            <div class="kpi-label">Horas esta semana</div>
            <div class="kpi-value"><span id="kpi-week-hours">—</span></div>
            <div class="kpi-foot" id="kpi-week-foot">Objetivo: 15 h</div>
            <div class="kpi-progress"><div id="kpi-week-bar"></div></div>
          </article>
          <article class="kpi">
            <div class="kpi-label">Horas acumuladas</div>
            <div class="kpi-value" id="kpi-total-hours">—</div>
            <div class="kpi-foot">todas las categorías</div>
          </article>
        </section>
  
        <section class="card donut-card">
          <div class="topbar">
            <div id="scopeLabel" style="font-size:12px;color:var(--muted)">Distribución por: Mes actual</div>
            <div class="scope" aria-label="Cambiar contexto de distribución">
              <button type="button" data-scope="month" class="active">Mes</button>
              <button type="button" data-scope="hist">Histórico</button>
            </div>
          </div>
          <div class="donut-wrap">
            <div class="donut" id="donut" role="img" aria-label="Distribución de horas por categoría">
              <div class="donut-center">
                <div class="center-top">Total</div>
                <div class="center-value" id="donut-total">—</div>
                <div class="center-foot">horas</div>
              </div>
            </div>
          </div>
          <ul class="legend" id="legend"></ul>
        </section>
  
        <section class="grid-4" id="categories"></section>
  
        <section class="card sessions" id="sessions">
          <div class="sessions-head">
            <h3>Sesiones</h3>
            <div style="display:flex;gap:10px;align-items:center">
              <div id="sessions-label" style="font-size:12px;color:var(--muted)"></div>
              <button id="toggleHist" class="pill">Mostrar histórico</button>
            </div>
          </div>
          <table>
            <thead><tr><th>Duración (min)</th><th>Categoría</th><th>Sesión</th><th>Fecha</th><th>URL</th></tr></thead>
            <tbody id="akTbody"></tbody>
          </table>
        </section>
      </div>
  
      <!-- PANE: AGREGADOS -->
      <div id="pane-agg" class="agg" style="display:none">
        <div class="card" style="padding:14px">
          <div class="head">
            <div class="tabs">
              <button class="tab active" data-t="meses">Meses</button>
              <button class="tab" data-t="años">Años</button>
              <button class="tab" data-t="total">Total</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <label class="muted" for="an-year">Año</label>
              <select id="an-year"></select>
              <button id="btnPrev" class="pill" style="display:none">Mostrar anteriores</button>
            </div>
          </div>
  
          <div id="tab-meses">
            <table>
              <thead><tr><th>Mes</th><th>Horas</th><th>Sesiones</th></tr></thead>
              <tbody id="month-rows"></tbody>
            </table>
          </div>
  
          <div id="tab-años" style="display:none">
            <table>
              <thead><tr><th>Año</th><th>Horas</th><th>Sesiones</th></tr></thead>
              <tbody id="year-rows"></tbody>
            </table>
          </div>
  
          <div id="tab-total" style="display:none">
            <div class="kpi-total">
              <div class="box"><div class="title">Horas totales</div><div class="value" id="kpiAggTotal">—</div></div>
              <div class="box"><div class="title">Sesiones totales</div><div class="value" id="kpiAggCount">—</div></div>
              <div class="box"><div class="title">Promedio por sesión</div><div class="value" id="kpiAggAvg">—</div></div>
            </div>
          </div>
  
          <div class="muted" style="margin-top:8px">Fuente: CSV público (añade ?csv=tudocumento o define window.ANIMATEK90_CSV_URL).</div>
        </div>
      </div>
    </div>
  
    <script>
    (()=>{ // IIFE único (un solo fetch y datos compartidos)
      const params = new URLSearchParams(location.search);
      const queryCSV = params.get('csv') || '';
      const RAW_CSV = (window.ANIMATEK90_CSV_URL || queryCSV || '').trim();
      const CSV_URL = RAW_CSV ? "https://r.jina.ai/http://" + RAW_CSV.replace(/^https?:\/\//,'') : null;
      const SAMPLE_CSV = `Categoria,Duracion,Fecha,Sesion,URL
Bitwig Production,120,2024-04-01,Sesión 241,https://youtu.be/demo-bitwig
Digitakt Sketching,90,2024-04-03,Sesión 242,https://youtu.be/demo-digitakt
VCV Rack Patch,75,2024-04-05,Sesión 243,
Oxi One Ideas,60,2024-04-06,Sesión 244,https://youtu.be/demo-oxi
Bitwig Production,95,2024-05-02,Sesión 245,
Digitakt Sketching,110,2024-05-05,Sesión 246,https://youtu.be/demo-digitakt-2
Field Recording,80,2024-05-08,Sesión 247,
VCV Rack Patch,100,2024-05-10,Sesión 248,https://youtu.be/demo-vcv`;
      let usingSample = !CSV_URL;
      const WEEK_GOAL_HOURS = 37;
  
      const NOW = new Date();
      const NOW_Y = NOW.getFullYear(), NOW_M = NOW.getMonth();
      const M = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  
      /* ---------- Utils ---------- */
      function parseCSV(text){
        let s=(text||'').replace(/^\uFEFF/,'').replace(/\r\n?/g,'\n');
        const first=s.split('\n',1)[0]||'';
        const delim=(first.match(/;/g)||[]).length>(first.match(/,/g)||[]).length?';':',';
        const rows=[]; let cur=[],field='',q=false;
        for(let i=0;i<s.length;i++){
          const c=s[i], n=s[i+1];
          if(q){ if(c=='"'&&n=='"'){field+='"';i++;} else if(c=='"'){q=false;} else field+=c; }
          else { if(c=='"'){q=true;} else if(c===delim){cur.push(field);field='';}
                 else if(c=='\n'){cur.push(field);rows.push(cur);cur=[];field='';} else field+=c; }
        }
        if(field!==''||cur.length){cur.push(field);rows.push(cur);}
        return rows.map(r=>r.map(x=>String(x??'').trim()));
      }
      const fmtNum = n => (Math.round(n*10)/10).toString().replace('.',',');
      const toNum  = x => { const n=parseFloat(String(x).replace(',','.')); return isNaN(n)?0:n; };
  
      function parseDateFlexible(raw){
        if(!raw) return null;
        let s = String(raw).trim().split(/[ T]/)[0];
        let m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
        if(m){ let dd=+m[1], mm=+m[2]-1, yy=+m[3]; if(yy<100) yy+=2000; const d=new Date(yy,mm,dd); return isNaN(d)?null:d; }
        m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
        if(m){ const d=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(d)?null:d; }
        const d=new Date(s); return isNaN(d)?null:d;
      }
  
      function parseDurationToMinutes(raw){
        if(raw==null) return 0;
        if(typeof raw==="number" && isFinite(raw)){ if(raw>0 && raw<1) return raw*1440; return raw; }
        const txt=String(raw).trim(); if(!txt) return 0;
        const normalized = txt.replace(',', '.');
        if(/^-?\d+(\.\d+)?$/.test(normalized)){
          const num=parseFloat(normalized);
          if(!isNaN(num)){ if(num>0 && num<1) return num*1440; return num; }
        }
        const colon = normalized.match(/^(\d+):(\d{1,2})(?::(\d{1,2}))?$/);
        if(colon){
          const first=+colon[1], second=+colon[2], third=colon[3]?+colon[3]:0;
          if(first>=24 && !colon[3]) return first + second/60;
          return first*60 + second + third/60;
        }
        const iso = normalized.match(/^PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?$/i);
        if(iso){ return (+iso[1]||0)*60 + (+iso[2]||0) + (+iso[3]||0)/60; }
        const human = normalized.match(/(\d+(?:\.\d+)?)\s*h(?:oras?)?(?:\s+(\d+(?:\.\d+)?)\s*m(?:inutos?)?)?/i);
        if(human){ return parseFloat(human[1]||0)*60 + parseFloat(human[2]||0); }
        return 0;
      }
  
      function mapRows(arr){
        if(!arr.length) return [];
        const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
        const header = arr[0].map(norm);
        const find = (...keys)=> header.findIndex(h => keys.some(k => h.includes(k)));
        let iCat = find('categoria','category'); if(iCat<0) iCat=0;
        let iDur = find('duracion','minutos','duration'); if(iDur<0) iDur=1;
        let iDat = find('fecha','date'); if(iDat<0) iDat=3;
        let iSes = find('sesion','session'); if(iSes<0) iSes=4;
        let iUrl = find('url','enlace','link'); if(iUrl<0) iUrl=5;
  
        const out=[];
        for(let r=1;r<arr.length;r++){
          const row=arr[r]; if(!row || row.every(x=>!x)) continue;
          const d=parseDateFlexible(row[iDat]); if(!d) continue;
          out.push({
            categoria: row[iCat]||'',
            duracion:  parseDurationToMinutes(row[iDur]),
            fechaISO:  d.toISOString().slice(0,10),
            fechaRaw:  row[iDat]||'',
            sesion:    row[iSes]||'',
            youtube:   row[iUrl]||'',
            y: d.getFullYear(), m: d.getMonth()
          });
        }
        return out;
      }
  
      function weekRangeISO(d=new Date()){
        const dow=(d.getDay()+6)%7; // 0=Lunes..6=Domingo
        const monday=new Date(d.getFullYear(),d.getMonth(),d.getDate()-dow);
        const sunday=new Date(monday.getFullYear(),monday.getMonth(),monday.getDate()+6);
        const toISO=x=>x.toISOString().slice(0,10);
        return {fromISO:toISO(monday), toISO:toISO(sunday)};
      }
  
      /* ---------- Paleta por categoría (estables y separadas) ---------- */
      function baseHue(name){
        const k=(name||'').toLowerCase().trim();
        if(k.startsWith('bitwig'))   return 295;
        if(k.startsWith('digitakt')) return 220;
        if(k.startsWith('vcv rack')) return 150;
        if(k.startsWith('oxi one'))  return 165;
        let h=0; for(let i=0;i<k.length;i++) h=(h*31+k.charCodeAt(i))%360;
        return h;
      }
      function angDist(a,b){ let d=Math.abs(a-b)%360; return d>180?360-d:d; }
      function paletteFor(names){
        const items=names.map(n=>({name:n,h:baseHue(n)})).sort((a,b)=>a.h-b.h);
        const used=[]; const res={}; const MIN=28, GOLD=137.50776405;
        for(const it of items){ let h=it.h, tries=0;
          while(tries<18 && used.some(u=>angDist(u,h)<MIN)){ h=(h+GOLD)%360; tries++; }
          used.push(h); res[it.name]=`hsl(${Math.round(h)} 65% 46%)`;
        }
        return res;
      }
      function conicStops(parts){
        const total = parts.reduce((a,b)=>a+b.hours,0); if(total<=0) return "#e6ebf5 0 360deg";
        let acc=0; return parts.map(p=>{ const from=(acc/total)*360; acc+=p.hours; const to=(acc/total)*360; return `${p.color} ${from}deg ${to}deg`; }).join(', ');
      }
      const tcase = s => (s||'').replace(/\w\S*/g,t=>t[0].toUpperCase()+t.slice(1));
  
      /* ---------- Estado UI ---------- */
      const SAMPLE_ROWS = mapRows(parseCSV(SAMPLE_CSV));
      let rows=[];               // dataset completo
      let topScope='month';      // 'month' | 'hist'
      let showAll=false;         // tabla sesiones
      let catFilter=null;        // filtro de categoría
      let aggData=null;          // agregados para Meses/Años/Total
  
      /* ---------- Render DASHBOARD ---------- */
      const donutEl   = document.getElementById('donut');
      const legendEl  = document.getElementById('legend');
      const catsEl    = document.getElementById('categories');
      const scopeEl   = document.querySelector('.scope');
      const scopeLbl  = document.getElementById('scopeLabel');
      const tb        = document.getElementById('akTbody');
      const lab       = document.getElementById('sessions-label');
      const btnHist   = document.getElementById('toggleHist');
      const weekBox   = document.getElementById('kpi-week');
      const weekValEl = document.getElementById('kpi-week-hours');
      const weekFoot  = document.getElementById('kpi-week-foot');
      const weekBar   = document.getElementById('kpi-week-bar');
      const demoBanner = document.getElementById('demoBanner');
  
      function calcParts(){
        const base=(topScope==='month') ? rows.filter(r=>r.y===NOW_Y && r.m===NOW_M) : rows;
        const totals=new Map();
        for(const r of base){
          let name=(r.categoria||'').trim();
          if(!name) name='Sin categoría';
          const key=name.toLowerCase();
          if(!totals.has(key)) totals.set(key,{name,hours:0});
          totals.get(key).hours += (r.duracion||0)/60;
        }
        if(!totals.size) totals.set('__empty__',{name:'Sin categoría',hours:0});
        const parts=[...totals.values()].sort((a,b)=>{
          if(b.hours!==a.hours) return b.hours-a.hours;
          return a.name.localeCompare(b.name);
        });
        const palette=paletteFor(parts.map(p=>p.name));
        return parts.map(p=>({name:p.name, hours:p.hours, color: palette[p.name]||'#e6ebf5'}));
      }

      function renderTop(){
        const parts=calcParts();
        donutEl.style.background = `conic-gradient(${conicStops(parts)})`;
        scopeLbl.textContent = `Distribución por: ${topScope==='month'?'Mes actual':'Histórico'}`;
        legendEl.innerHTML = parts.map(p=>`<li data-cat="${encodeURIComponent(p.name)}"><span class="swatch" style="background:${p.color}"></span><b>${tcase(p.name)}</b> — ${fmtNum(p.hours)} h</li>`).join('');
        const maxH=Math.max(...parts.map(p=>p.hours),0);
        catsEl.innerHTML = parts.map(p=>{
          const pct=maxH>0 ? Math.max(4,(p.hours/maxH)*100) : 0;
          return `<article class="cat" data-cat="${encodeURIComponent(p.name)}">
            <div class="name">${tcase(p.name)}</div>
            <div class="hours">${fmtNum(p.hours)} h</div>
            <div class="bar" style="--c:${p.color};--w:${pct}%"></div>
          </article>`;
        }).join('');
        const match = s=>decodeURIComponent(s).toLowerCase().trim()===(catFilter||'');
        [...legendEl.querySelectorAll('li')].forEach(li=>li.classList.toggle('active',match(li.dataset.cat)));
        [...catsEl.querySelectorAll('.cat')].forEach(a=>a.classList.toggle('active',match(a.dataset.cat)));
      }
  
      function renderSessions(){
        const base = (showAll?rows:rows.filter(r=>r.y===NOW_Y && r.m===NOW_M));
        const filtered = catFilter ? base.filter(r => (r.categoria||'').toLowerCase().trim()===catFilter) : base;
        const list = filtered.slice().sort((a,b)=>b.fechaISO.localeCompare(a.fechaISO));
        let html='';
        for(const r of list){
          const url=r.youtube?`<a href="${r.youtube}" target="_blank" rel="noopener">Abrir</a>`:'—';
          html += `<tr><td>${Math.round(r.duracion||0)}</td><td>${r.categoria||'—'}</td><td>${r.sesion||'—'}</td><td>${r.fechaRaw||r.fechaISO}</td><td>${url}</td></tr>`;
        }
        tb.innerHTML = html || `<tr><td colspan="5" style="color:#6b7280">Sin sesiones en ${M[NOW_M]} ${NOW_Y}</td></tr>`;
        lab.textContent = (showAll ? "Mostrando: histórico completo" : `Mes actual: ${M[NOW_M]} ${NOW_Y}`) + (catFilter? ` · Filtro: ${tcase(catFilter)}` : "");
        btnHist.textContent = showAll ? "Mostrar solo mes actual" : "Mostrar histórico";
      }
  
      function renderWeekKPI(){
        const {fromISO, toISO} = weekRangeISO(NOW);
        const minutes = rows.filter(r => r.fechaISO>=fromISO && r.fechaISO<=toISO).reduce((a,b)=>a+(b.duracion||0),0);
        const hours = minutes/60;
        const pct = WEEK_GOAL_HOURS>0 ? Math.min(1, hours/WEEK_GOAL_HOURS) : 0;
        weekValEl.textContent = `${fmtNum(hours)} h`;
        weekFoot.textContent  = `Objetivo: ${fmtNum(WEEK_GOAL_HOURS)} h · ${fmtNum(pct*100)}%`;
        weekBar.style.width   = `${pct*100}%`;
        weekBox.classList.toggle('progress-done', hours>=WEEK_GOAL_HOURS);
      }
  
      /* ---------- Agregados Mes/Año/Total ---------- */
      const selYear  = document.getElementById('an-year');
      const btnPrev  = document.getElementById('btnPrev');
      const monthRows= document.getElementById('month-rows');
      const yearRows = document.getElementById('year-rows');
      const kpiAggTotal = document.getElementById('kpiAggTotal');
      const kpiAggCount = document.getElementById('kpiAggCount');
      const kpiAggAvg   = document.getElementById('kpiAggAvg');
  
      function buildAgg(rows){
        const byYear={}, byYM={}; let totalMin=0, totalCount=0;
        for(const r of rows){
          const y=r.y, m=r.m;
          const dur=r.duracion||0;
          byYear[y] ??= {min:0,count:0};
          byYear[y].min+=dur; byYear[y].count++;
          const key=`${y}-${String(m+1).padStart(2,'0')}`;
          byYM[key] ??= {min:0,count:0,y,m};
          byYM[key].min+=dur; byYM[key].count++;
          totalMin += dur; totalCount++;
        }
        const years = Object.keys(byYear).map(Number).sort((a,b)=>b-a);
        return {byYear, byYM, years, totalMin, totalCount};
      }
  
      let showPrev=false;
      function updatePrevBtn(){
        if(+selYear.value===NOW_Y){
          btnPrev.style.display='inline-block';
          btnPrev.textContent = showPrev ? 'Ocultar anteriores' : 'Mostrar anteriores';
        }else{
          btnPrev.style.display='none';
        }
      }
  
      function fillAggUI(){
        // select años
        selYear.innerHTML = (aggData.years.length?aggData.years:[NOW_Y]).map(y=>`<option value="${y}">${y}</option>`).join('');
        selYear.value = aggData.years[0] || NOW_Y;
        // años tabla
        yearRows.innerHTML='';
        aggData.years.forEach(y=>{
          const r=aggData.byYear[y]||{min:0,count:0};
          yearRows.insertAdjacentHTML('beforeend', `<tr><td>${y}</td><td>${fmtNum(r.min/60)}</td><td>${r.count}</td></tr>`);
        });
        // total KPIs
        kpiAggTotal.textContent = fmtNum(aggData.totalMin/60);
        kpiAggCount.textContent = aggData.totalCount;
        kpiAggAvg.textContent   = (aggData.totalCount ? (aggData.totalMin/60/aggData.totalCount) : 0).toFixed(1).replace('.',',') + ' h';
        // meses tabla inicial
        showPrev=false; fillMonths();
      }
  
      function fillMonths(){
        const y=+selYear.value;
        monthRows.innerHTML='';
        const startM=(y===NOW_Y && !showPrev) ? NOW_M : 0;
        for(let m=startM;m<12;m++){
          const k=`${y}-${String(m+1).padStart(2,'0')}`;
          const r=aggData.byYM[k]||{min:0,count:0};
          monthRows.insertAdjacentHTML('beforeend', `<tr><td>${M[m]}</td><td>${fmtNum((r.min||0)/60)}</td><td>${r.count||0}</td></tr>`);
        }
        updatePrevBtn();
      }
  
      /* ---------- Interacciones ---------- */
      document.querySelectorAll('#an90-all .tabg').forEach(b=>{
        b.addEventListener('click', ()=>{
          document.querySelectorAll('#an90-all .tabg').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          const pane=b.dataset.pane;
          document.getElementById('pane-dashboard').style.display = (pane==='dashboard')?'':'none';
          document.getElementById('pane-agg').style.display       = (pane==='agg')?'':'none';
        });
      });
  
      scopeEl.addEventListener('click',(e)=>{
        const b=e.target.closest('button[data-scope]'); if(!b) return;
        topScope=b.dataset.scope;
        scopeEl.querySelectorAll('button').forEach(x=>x.classList.toggle('active',x===b));
        renderTop();
      });
      legendEl.addEventListener('click',(e)=>{
        const li=e.target.closest('li[data-cat]'); if(!li) return;
        const sel=decodeURIComponent(li.dataset.cat).toLowerCase().trim();
        catFilter = (catFilter===sel)? null : sel;
        renderTop(); renderSessions();
      });
      catsEl.addEventListener('click',(e)=>{
        const card=e.target.closest('article[data-cat]'); if(!card) return;
        const sel=decodeURIComponent(card.dataset.cat).toLowerCase().trim();
        catFilter = (catFilter===sel)? null : sel;
        renderTop(); renderSessions();
      });
      btnHist.addEventListener('click',()=>{ showAll=!showAll; renderSessions(); },{passive:true});
  
      // Agg tabs
      const tabM=document.getElementById('tab-meses');
      const tabY=document.getElementById('tab-años');
      const tabT=document.getElementById('tab-total');
      document.querySelectorAll('#pane-agg .tab').forEach(b=>{
        b.addEventListener('click', ()=>{
          document.querySelectorAll('#pane-agg .tab').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          const t=b.dataset.t;
          tabM.style.display=(t==='meses')?'':'none';
          tabY.style.display=(t==='años')?'':'none';
          tabT.style.display=(t==='total')?'':'none';
        });
      });
      selYear.addEventListener('change', ()=>{ showPrev=false; fillMonths(); });
      btnPrev.addEventListener('click', ()=>{ showPrev=!showPrev; fillMonths(); });
  
      /* ---------- Datos ---------- */
      async function loadData(){
        if(CSV_URL){
          try{
            const res=await fetch(CSV_URL,{cache:'no-store'});
            if(!res.ok) throw new Error('HTTP '+res.status);
            const text=await res.text();
            usingSample=false;
            return mapRows(parseCSV(text));
          }catch(err){
            console.warn('[90m] No se pudo cargar el CSV remoto, usando datos de ejemplo.', err);
          }
        }
        usingSample=true;
        return SAMPLE_ROWS.map(r=>({...r}));
      }
  
      async function main(){
        rows = await loadData();
        rows.sort((a,b)=>a.fechaISO.localeCompare(b.fechaISO));
        // totales dashboard
        const totalMin = rows.reduce((a,b)=>a+(b.duracion||0),0);
        const totalH   = totalMin/60;
        document.getElementById('kpi-total-hours').textContent = fmtNum(totalH);
        document.getElementById('donut-total').textContent     = fmtNum(totalH);
        if(usingSample && demoBanner){
          demoBanner.style.display='flex';
        }else if(demoBanner){
          demoBanner.style.display='none';
        }
 
        if(!rows.length){
          document.getElementById('sessions-label').textContent = 'No hay datos en la hoja o las fechas no se pudieron leer';
        }
  
        renderWeekKPI();
        renderTop();
        renderSessions();
  
        // agregados
        aggData = buildAgg(rows);
        fillAggUI();
      }
  
      document.readyState==="loading"
        ? document.addEventListener("DOMContentLoaded", ()=>main().catch(e=>console.error('[90m]',e)))
        : main().catch(e=>console.error('[90m]',e));
    })();
    </script>
  </section>
  
