<div id="an-90m"></div>

<style>
/* ===== Meses/Años/Total — tema claro Animatek ===== */
#an-90m{--text:#111;--muted:#6b7280;--line:#e5e7eb;--card:#fff;--accent:#2170F5;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}
#an-90m .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin:14px 0}
#an-90m .head{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px}
#an-90m .tabs{display:flex;gap:6px}
#an-90m .tab{background:#f3f4f6;border:1px solid var(--line);border-radius:999px;padding:6px 12px;font-size:13px;cursor:pointer}
#an-90m .tab.active{background:#eef2ff;border-color:#c7d2fe;color:#1f2a7a}
#an-90m .pill{background:#f3f4f6;border:1px solid var(--line);border-radius:999px;padding:6px 12px;font-size:12px;cursor:pointer}
#an-90m select{background:#fff;border:1px solid var(--line);border-radius:10px;padding:6px 10px}
#an-90m table{width:100%;border-collapse:collapse}
#an-90m th,#an-90m td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
#an-90m th{color:var(--muted);font-weight:600}
#an-90m .muted{color:var(--muted);font-size:12px}

/* KPIs Total */
#an-90m .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:6px}
#an-90m .kpi .box{background:#f9fafb;border:1px solid var(--line);border-radius:10px;padding:12px}
#an-90m .kpi .title{font-size:12px;color:var(--muted);margin-bottom:4px}
#an-90m .kpi .value{font-size:26px;font-weight:800}
</style>

<script>
(()=> {
  // Tu CSV publicado (bloqueado por CORS si se usa directo) → usamos proxy de solo lectura:
  const RAW_CSV = 'URL';
  const CSV_URL = 'https://r.jina.ai/http://' + RAW_CSV.replace(/^https?:\/\//,'');

  const M = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  const now = new Date(); const NOW_Y = now.getFullYear(); const NOW_M = now.getMonth();
  const fmtH = min => (min/60).toFixed(1).replace('.',',');

  // CSV parser simple con comillas
  function parseCSV(text){
    const out=[], lines=text.replace(/\r\n?/g,'\n').split('\n');
    for (const line of lines){ if(!line) continue;
      let q=false, field='', row=[];
      for (let i=0;i<line.length;i++){
        const c=line[i], n=line[i+1];
        if(q){ if(c=='"'&&n=='"'){field+='"';i++;} else if(c=='"'){q=false;} else field+=c; }
        else { if(c=='"'){ q=true; } else if(c==','){ row.push(field); field=''; } else field+=c; }
      }
      row.push(field); out.push(row);
    }
    return out;
  }
  const toNum = x => { const n=parseFloat(String(x).replace(',','.')); return isNaN(n)?0:n; };

  function build(rows){
    const byYear={}, byYM={}; let totalMin=0, totalCount=0;
    for (const r of rows){
      if(!r || r.length<4) continue;
      if(String(r[0]).toLowerCase().includes('categoria')) continue;
      const dur = toNum(r[1]); const ds=(r[3]||'').trim(); if(!ds) continue;
      const d=new Date(ds); if(isNaN(d)) continue;
      const y=d.getFullYear(), m=d.getMonth();
      byYear[y] ??= {min:0,count:0}; byYear[y].min+=dur; byYear[y].count++;
      const key=`${y}-${String(m+1).padStart(2,'0')}`;
      byYM[key] ??= {min:0,count:0,y,m}; byYM[key].min+=dur; byYM[key].count++;
      totalMin += dur; totalCount++;
    }
    const years = Object.keys(byYear).map(Number).sort((a,b)=>b-a);
    return {byYear, byYM, years, totalMin, totalCount};
  }

  function render(root, data){
    root.innerHTML = `
      <div class="card">
        <div class="head">
          <div class="tabs">
            <button class="tab active" data-t="meses">Meses</button>
            <button class="tab" data-t="años">Años</button>
            <button class="tab" data-t="total">Total</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted" for="an-year">Año</label>
            <select id="an-year"></select>
            <button id="btnPrev" class="pill" style="display:none">Mostrar anteriores</button>
          </div>
        </div>

        <div id="tab-meses">
          <table>
            <thead><tr><th>Mes</th><th>Horas</th><th>Sesiones</th></tr></thead>
            <tbody id="month-rows"></tbody>
          </table>
        </div>

        <div id="tab-años" style="display:none">
          <table>
            <thead><tr><th>Año</th><th>Horas</th><th>Sesiones</th></tr></thead>
            <tbody id="year-rows"></tbody>
          </table>
        </div>

        <div id="tab-total" style="display:none">
          <div class="kpi">
            <div class="box"><div class="title">Horas totales</div><div class="value">${fmtH(data.totalMin)}</div></div>
            <div class="box"><div class="title">Sesiones totales</div><div class="value">${data.totalCount}</div></div>
            <div class="box"><div class="title">Promedio por sesión</div><div class="value">${(data.totalCount? (data.totalMin/60/data.totalCount):0).toFixed(1).replace('.',',')} h</div></div>
          </div>
        </div>

        <div class="muted" style="margin-top:8px">Fuente: Google Sheets (CSV publicado).</div>
      </div>`;

    const sel = root.querySelector('#an-year');
    sel.innerHTML = (data.years.length?data.years:[NOW_Y]).map(y=>`<option value="${y}">${y}</option>`).join('');
    sel.value = data.years[0] || NOW_Y;

    let showPrev = false;
    const btnPrev = root.querySelector('#btnPrev');

    function updatePrevBtn(){
      if (+sel.value === NOW_Y){
        btnPrev.style.display = 'inline-block';
        btnPrev.textContent = showPrev ? 'Ocultar anteriores' : 'Mostrar anteriores';
      } else {
        btnPrev.style.display = 'none';
      }
    }

    function fillMonths(){
      const y = +sel.value;
      const tbody = root.querySelector('#month-rows'); tbody.innerHTML = '';
      const startM = (y===NOW_Y && !showPrev) ? NOW_M : 0;
      for (let m=startM; m<12; m++){
        const k = `${y}-${String(m+1).padStart(2,'0')}`;
        const r = data.byYM[k] || {min:0,count:0};
        tbody.insertAdjacentHTML('beforeend', `<tr><td>${M[m]}</td><td>${fmtH(r.min)}</td><td>${r.count}</td></tr>`);
      }
      updatePrevBtn();
    }

    // Inicial
    fillMonths();

    // Años (tabla)
    const yBody = root.querySelector('#year-rows'); yBody.innerHTML='';
    data.years.forEach(y=>{ const r=data.byYear[y]||{min:0,count:0};
      yBody.insertAdjacentHTML('beforeend', `<tr><td>${y}</td><td>${fmtH(r.min)}</td><td>${r.count}</td></tr>`); });

    // Eventos
    sel.onchange = ()=>{ showPrev=false; fillMonths(); };
    btnPrev.onclick = ()=>{ showPrev = !showPrev; fillMonths(); };

    // Tabs
    const tabM = root.querySelector('#tab-meses');
    const tabY = root.querySelector('#tab-años');
    const tabT = root.querySelector('#tab-total');
    root.querySelectorAll('.tab').forEach(b=>{
      b.onclick = ()=>{
        root.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const t=b.dataset.t;
        tabM.style.display=(t==='meses')?'':'none';
        tabY.style.display=(t==='años')?'':'none';
        tabT.style.display=(t==='total')?'':'none';
      };
    });
  }

  // Carga con timeout para no colgar el builder
  function fetchWithTimeout(url,ms=10000){ const ac=new AbortController(); const id=setTimeout(()=>ac.abort(),ms);
    return fetch(url,{cache:'no-store',signal:ac.signal}).finally(()=>clearTimeout(id)); }

  const root=document.getElementById('an-90m');
  fetchWithTimeout(CSV_URL)
    .then(r=>r.ok?r.text():Promise.reject(new Error('HTTP '+r.status)))
    .then(t=>render(root, build(parseCSV(t))))
    .catch(e=>{ root.innerHTML='<div class="card">No se pudo cargar el CSV (CORS/red). Revisa que esté “Publicado en la web”.</div>'; console.error('[90m]',e); });
})();
</script>
